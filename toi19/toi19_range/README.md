<!-- @codegen_problem begin -->
# TOI19 range - à¸šà¹‰à¸²à¸™à¸¡à¸¸à¸‡ (Range)

[ğŸ  à¸£à¸§à¸¡à¹€à¸‰à¸¥à¸¢ TOI19](../)

[ğŸ’ problem.pdf](./toi19_range.pdf)

[ğŸ‰ solution_segment_tree.cpp](./toi19_range_segment_tree.cpp)

[ğŸ‰ solution.cpp](./toi19_range.cpp)

<img width="700" src="https://github.com/krist7599555/toi/assets/19445033/84d7f1c6-da5e-47ca-a795-7161b801600e" />
<!-- @codegen_problem end -->
# TOI19 range

[ğŸ’ problem.pdf](./toi19_range.pdf)

[ğŸ‰ solution.cpp](./toi19_range.cpp)

[ğŸ‰ solution_segment_tree.cpp](./toi19_range_segment_tree.cpp)

<img width="700" alt="image" src="https://github.com/krist7599555/toi/assets/19445033/84d7f1c6-da5e-47ca-a795-7161b801600e">

## Solution 1 LIS

LIS (longest increasing subsequence)

sort à¸•à¸²à¸¡ R à¹à¸¥à¹‰à¸§ à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¸•à¸²à¸¡ -L (à¸ˆà¸°à¹„à¸”à¹‰à¸—à¸³à¸ à¸¹à¹€à¸‚à¸²à¸‚à¹‰à¸²à¸‡à¹ƒà¸™à¸à¹ˆà¸­à¸™)

à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸•à¸²à¸¡à¸ à¸²à¸à¸‚à¹‰à¸²à¸‡à¸‚à¸™à¸ˆà¸°à¹„à¸”à¹‰à¹€à¸›à¹‡à¸™

![LIS solution](https://github.com/krist7599555/toi/assets/19445033/37b36bdc-4f76-4f64-80c7-c96e00af74e9)

```python
idx=[2,6];   lis = 2*;      à¸•à¸­à¸š 1
idx=[6,7];   lis = 6*;      à¸•à¸­à¸š 1
idx=[3,8];   lis = 6 3*;    à¸•à¸­à¸š 2
idx=[1,9];   lis = 6 3 1*;  à¸•à¸­à¸š 3
idx=[7,11];  lis = 7* 3 1;  à¸•à¸­à¸š 1
idx=[11,13]; lis = 11* 3 1; à¸•à¸­à¸š 1
idx=[9,13];  lis = 11 9* 1; à¸•à¸­à¸š 2
```

à¹ƒà¸«à¹‰à¸¥à¸­à¸‡à¸¡à¸­à¸‡ R à¸™à¸´à¹ˆà¸‡à¹†à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸‚à¸¢à¸±à¸š L à¹„à¸›à¸—à¸²à¸‡à¸‹à¹‰à¸²à¸¢à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹† à¸ªà¸±à¸‡à¹€à¸à¸•à¸¸à¸§à¹ˆà¸² à¸¢à¸´à¹ˆà¸‡à¸‚à¸¢à¸±à¸š L à¹„à¸›à¸—à¸²à¸‡à¸‹à¹‰à¸²à¸¢à¸¡à¸²à¸à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ à¸ˆà¸³à¸™à¸§à¸™à¸¥à¸¹à¸à¸—à¸µà¹ˆà¸—à¸³à¹„à¸”à¹‰à¸¢à¸´à¹ˆà¸‡à¸”à¸µà¸‚à¸¶à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹†

à¸–à¹‰à¸²à¹€à¸£à¸²à¸¡à¸µà¸ à¸¹à¹€à¸‚à¸²à¸«à¸¥à¸²à¸¢à¸•à¸±à¸§à¸—à¸µà¹ˆà¸¡à¸µà¸¥à¸¹à¸à¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¸à¹‡à¸„à¸§à¸£à¹€à¸¥à¸·à¸­à¸à¹€à¸à¹‡à¸šà¹€à¸‰à¸à¸²à¸°à¹à¸„à¹ˆà¸•à¸±à¸§à¸—à¸µà¹ˆà¹€à¸ˆà¸­à¹„à¸”à¹‰à¹„à¸§à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸à¹ˆà¸­à¸™ (L à¹ƒà¸à¸¥à¹‰à¹† R à¸ˆà¸°à¹€à¸ˆà¸­à¹„à¸”à¹‰à¹„à¸§)

à¸ˆà¸²à¸à¹à¸™à¸§à¸„à¸´à¸”à¸™à¸µà¹‰à¸ˆà¸°à¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸à¸±à¸šà¸à¸²à¸£à¸—à¸³ longest increasing subsequence à¹à¸šà¸š binary search à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹€à¸‰à¸à¸²à¸°à¸ à¸¹à¹€à¸‚à¸²à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹„à¸›à¹€à¸£à¸·à¹ˆà¸­à¸¢à¹† à¹‚à¸”à¸¢à¸—à¸´à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸à¹ˆà¸²à¹„à¸›à¹€à¸¥à¸¢à¸–à¹‰à¸²à¸¡à¸µà¸„à¹ˆà¸²à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸¡à¸µà¸„à¹ˆà¸²à¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¹à¸•à¹ˆà¹€à¸ˆà¸­à¹„à¸”à¹‰à¸‡à¹ˆà¸²à¸¢à¸à¸§à¹ˆà¸²

---

## Solution 2 Segment tree

Segment Tree _(à¸‚à¸­à¸‡à¹‚à¸„à¸•à¸£à¸‚à¸µà¹‰à¹‚à¸à¸‡ à¹ƒà¸„à¸£à¹€à¸‚à¸µà¸¢à¸™à¹€à¸›à¹‡à¸™à¸ˆà¸°à¹„à¸”à¹‰à¹€à¸›à¸£à¸µà¸¢à¸š)_
![image](https://github.com/krist7599555/toi/assets/19445033/1529fa08-a95d-4db3-bd09-42d68682921c)

> à¸«à¸£à¸·à¸­ fenwick tree à¸—à¸µà¹ˆà¹€à¸­à¸µà¸¢à¸‡à¸à¸£à¸²à¸Ÿ 45à¸­à¸‡à¸¨à¸² à¸à¹‡à¹„à¸”à¹‰ à¹à¸•à¹ˆà¸¡à¸±à¸™à¸ˆà¸°à¸”à¸¹à¸¢à¸²à¸à¸«à¸™à¹ˆà¸­à¸¢à¹†
>
> <img width="400" alt="image" src="https://github.com/krist7599555/toi/assets/19445033/4183e9ca-5d86-4a2f-a8e8-6c860fef92dc">

### Observation 1 Segment Tree + Sort

à¸‚à¹‰à¸­à¸™à¸µà¹‰à¸–à¹‰à¸²à¹ƒà¸Šà¹‰ segment tree à¸à¹‡à¹à¸à¹‰à¸•à¸£à¸‡à¹†à¸§à¹ˆà¸²

`size(node {l, r}) = max(node { >=l, <=r }) + 1`

à¹à¸•à¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸²à¸™à¸´à¸¢à¸²à¸¡à¸à¸²à¸£à¹€à¸Šà¹‡à¸„à¹„à¸§à¹†à¸§à¹ˆà¸² `[l1, r1]` à¸à¸±à¸š `[l2, r2]` à¹€à¸›à¹‡à¸™ subset à¸à¹‰à¸™à¸«à¸£à¸·à¸­à¹€à¸›à¸¥à¹ˆà¸² à¸–à¹‰à¸²à¹€à¸à¹‡à¸šà¸—à¸±à¹‰à¸‡ l1, l2, r1, r2 à¸¡à¸±à¸™à¸ˆà¸°à¸¢à¸²à¸à¹„à¸› à¹€à¸£à¸²à¹€à¸¥à¸¢à¹ƒà¸Šà¹‰à¸à¸²à¸£ sort à¹€à¸­à¸² à¹à¸¥à¹‰à¸§ query à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹à¸—à¸™

```python
         à¸­à¸¢à¸¹à¹ˆà¸•à¸£à¸‡à¸™à¸µà¹‰ à¸ªà¸™à¹ƒà¸ˆà¸—à¸µà¹ˆà¸Šà¹ˆà¸§à¸‡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ [l1, r1]
         v
[l       r]

à¸„à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¸™à¸µà¹‰à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¹‡à¸™à¸¥à¸¹à¸à¹„à¸”à¹‰à¸«à¸¡à¸” [l2, r2]
[l,      r] <= à¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸à¸´à¸”à¹€à¸„à¸ªà¸™à¸µà¹‰à¸—à¸µà¹ˆ l1 == l2 && r1 == r2
[l,    r]
[l,  r]
[l,r]
  [l,    r] <= à¹à¸•à¹ˆà¸ˆà¸°à¹€à¸à¸´à¸”à¹€à¸„à¸ªà¸™à¸µà¹‰à¸„à¸·à¸­ l1 < l2 && r1 == r2
               à¹€à¸£à¸²à¹€à¸¥à¸¢à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡ à¸ˆà¸²à¸ l à¸¡à¸²à¸à¹„à¸›à¸™à¹‰à¸­à¸¢ à¸–à¹‰à¸² r à¹€à¸—à¹ˆà¸²à¸à¸±à¸™
  [l,  r]
  [l,r]
     [l, r] <= à¹à¸•à¹ˆà¸ˆà¸°à¹€à¸à¸´à¸”à¹€à¸„à¸ªà¸™à¸µà¹‰à¸„à¸·à¸­ l1 < l2 && r1 == r2
     [l,r]
      [l,r] <= à¹à¸•à¹ˆà¸ˆà¸°à¹€à¸à¸´à¸”à¹€à¸„à¸ªà¸™à¸µà¹‰à¸„à¸·à¸­ l1 < l2 && r1 == r2
```

à¸ˆà¸²à¸à¸—à¸µà¹ˆà¹€à¸£à¸²à¸—à¸³à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡ `r` à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§à¸ˆà¸¶à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¹ˆà¸²à¹„à¸«à¸™à¹€à¸¥à¸¢à¸—à¸µà¹ˆ `>r` à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™

à¹€à¸£à¸²à¸ˆà¸¶à¸‡à¸™à¸´à¸¢à¸²à¸¡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸Šà¹ˆà¸§à¸‡ interval à¹„à¸§à¹‰à¹à¸„à¹ˆà¸—à¸µà¹ˆà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ `l` à¸à¹‡à¸à¸­ à¹€à¸à¸£à¸²à¸°à¸–à¹‰à¸²à¸¡à¸µà¸Šà¹ˆà¸§à¸‡à¹„à¸«à¸™à¸—à¸µà¹ˆ `l2<l1` à¸à¹‡à¹à¸›à¸¥à¸§à¹ˆà¸² `[l2, r2]` à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¹‡à¸™à¸¥à¸¹à¸à¸‚à¸­à¸‡ `[l1, r1]` à¹„à¸”à¹‰

### Observation 2 Compress Index

à¹à¸¥à¹‰à¸§à¸à¹‡à¸¡à¸µ trick à¸­à¸µà¸à¸™à¸´à¸”à¸™à¸¶à¸‡à¸„à¸·à¸­ à¸„à¹ˆà¸²à¸Šà¹ˆà¸§à¸‡à¸¡à¸±à¸™à¹€à¸¢à¸­à¸°à¸¡à¸²à¸à¹† `1e9` à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ˆà¸­à¸‡ array à¸‚à¸™à¸²à¸”à¸™à¸±à¹‰à¸™à¹„à¸”à¹‰ à¹à¸•à¹ˆà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸µà¹à¸„à¹ˆ `400,000` à¸•à¸±à¸§ à¹€à¸¥à¸¢à¸ªà¸²à¸¡à¸²à¸£à¸– compress index à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰à¸—à¸³à¹„à¸”à¹‰à¹‚à¸”à¸¢

- sort à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
- à¸—à¸³à¹ƒà¸«à¹‰ unique
- à¹à¸¥à¹‰à¸§à¸à¹‡à¸§à¸™ for à¹ƒà¸ªà¹ˆà¹€à¸¥à¸‚à¹ƒà¸«à¸¡à¹ˆ
- à¹à¸—à¸™à¸—à¸µà¹ˆà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹€à¸à¹ˆà¸² à¸”à¹‰à¸§à¸¢à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ idx à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸„à¹ˆà¸²à¸™à¸±à¹‰à¸™

```cpp
std::vector<int> big_arr;

// copy
std::vector<int> compress(big_arr.begin(), big_arr.end());
// sort
std::sort(compress.begin(), compress.end());
// unique
std::erase(std::unique(compress.begin(), compress.end()), compress.end());
// replace old value with new idx
for (int& val : big_arr) {
  int idx = std::lower_bound(compress.begin(), compress.end(), val) - compress.begin();
  val = idx;
}
```

à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰ map à¸—à¸³à¸à¹‡à¹„à¸”à¹‰

```cpp
std::vector<int> big_arr;
std::map<int,int> compress;
// sort + unique
for (int val : big_arr) compress[val] = 0;
// assign index
int i = 0;
for (auto& p : compress) p.second = i++;
// replace old value with new idx
for (int& val : big_arr) {
  int idx = compress[val];
  val = idx;
}
```
